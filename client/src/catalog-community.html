<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/iron-scroll-threshold/iron-scroll-threshold.html">

<link rel="import" href="catalog-styles.html">
<link rel="import" href="mark-down.html">
<link rel="import" href="progress-bar.html">

<dom-module id="catalog-community">
  <template>
    <style include="catalog-styles"></style>
    <style>
      h1.page-title {
        padding-bottom: 16px;
        border-bottom: 1px solid #ededed;
        width: 100%;
      }

      .sidebar {
        margin-top: 24px;
      }

      .sidebar-nav a[count]:after {
        content: attr(count);
        float: right;
        color: var(--theme-blue-grey);
      }

      .resource {
        padding: 24px 0;
        color: hsl(0, 0%, 45%);
        color: var(--theme-blue-grey);
        border-bottom: 1px solid #ededed;
        display: flex;
        flex-direction: column;
      }

      .resource-title {
        font-weight: 600;
        color: var(--theme-black);
      }

      .resource-author {
        margin-bottom: 16px;
        display: flex;
        align-items: center;
      }

      .resource-author svg {
        width: 16px;
        fill: #b1c2d6;
        margin-left: 8px;
      }

      img {
        max-width: 100%;
        margin: auto;
        margin-bottom: 16px;
      }

      .resource:hover:not(:active) {
        background: hsla(0, 0%, 98%, 1);
      }

    </style>

    <iron-ajax
      auto
      id="ajax"
      url="https://web-components-resources.appspot.com/resources[[_filterPath]]"
      handle-as="json"
      loading="{{_resourcesLoading}}"
      on-response="_onResourcesResponse"></iron-ajax>

    <iron-ajax
      id="contentAjax"
      handle-as="json"
      loading="{{_contentLoading}}"
      last-response="{{_content}}"></iron-ajax>

    <iron-scroll-threshold on-lower-threshold="_loadMore" id="threshold" scroll-target="document" lower-threshold="800"></iron-scroll-threshold>

    <template is="dom-if" if="[[!path]]">
      <h1 class="page-title">Community</h1>

      <div class="body">
        <div class="sidebar">
          <h1>Show</h1>
          <div class="sidebar-nav box">
            <a on-click="_filterChanged" active>All</a>
            <a on-click="_filterChanged">Articles</a>
            <a on-click="_filterChanged">Podcasts</a>
            <a on-click="_filterChanged">Presentations</a>
          </div>
        </div>

        <div class="main-content loader" loading$="[[!_resources]]">
          <template is="dom-repeat" items="[[_resources.results]]">
            <a href="[[_computeLink(item)]]" class="resource" aria-label="[[item.category]] titled [[item.title]]">
              <h1 class="resource-title">[[item.title]]</h1>
              <div class="resource-author">
                [[_formatDate(item.date)]]
                <svg viewBox="0 0 100 100" id="search-symbol"><use href$="/sprite.octicons.svg#[[_toSVG(item.category)]]"></use></svg>
              </div>
              <template is="dom-if" if="[[item.image]]">
                <img src="https://web-components-resources.appspot.com/assets/images/[[item.image]]">
              </template>
              <mark-down markdown="[[_stripHTML(item.excerpt)]]"></mark-down>
              <!-- [[item.link]] -->
            </a>
          </template>
          <progress-bar indeterminate hidden$="[[!_resourcesLoading]]"></progress-bar>
        </div>

      </div>
    </template>

    <template is="dom-if" if="[[path]]">
      <div class="loader" loading$="[[_contentLoading]]">
        <h1 class="page-title">[[_content.metadata.title]]</h1>
        <h3 class="page-subtitle">[[_formatDate(_content.metadata.original_date)]]</h3>
        <mark-down markdown="[[_content.content]]"></mark-down>
      </div>
    </template>
  </template>
  <script>
    Polymer({

      is: 'catalog-community',

      properties: {
        path: {
          type: String,
          observer: '_pathChanged',
        },

        visible: {
          type: Boolean,
          observer: '_visibilityChanged',
        },

        // Resources list object
        _resources: Object,

        // Article content
        _content: Object,
      },

      ready: function() {
        this._resources = null;
        this._filterPath = '';

        this._categorySVGMap = {
          podcasts: 'unmute',
          articles: 'file',
          presentations: 'device-camera-video',
        };
      },

      _visibilityChanged: function(visible) {
        this.$.threshold.toggleScrollListener(visible);
        if (visible) {
          this.$.threshold.clearTriggers();
          this.$.threshold.checkScrollThesholds();
        }
      },

      _loadMore: function() {
        if (!this.visible || this.path || !this._resources || this._resources.results.length >= this._resources.count)
          return;
        this.$.ajax.params = {offset: this._resources.results.length};
      },

      _onResourcesResponse: function() {
        if (this._resources) {
          this._resources.results = this._resources.results.concat(this.$.ajax.lastResponse.results);
          this.notifyPath('_resources.results');
        } else {
          this._resources = this.$.ajax.lastResponse;
          var filterLink = this.querySelector('.sidebar-nav a[active]');
          filterLink.setAttribute('count', this._resources.count);
        }

        this.$.threshold.clearTriggers();
      },

      _pathChanged: function(path) {
        if (!path) {
          this._content = null;
          this._visibilityChanged(this.visible);
          return;
        }
        Polymer.AppLayout.scroll(0);
        this.$.contentAjax.url = 'https://web-components-resources.appspot.com/content' + path;
        this.$.contentAjax.generateRequest();
      },

      _formatDate: function(dateString) {
        if (!dateString)
          return '';
        var date = new Date(dateString);
        return date.toLocaleString("en-us", {day: 'numeric', month: 'long', year: 'numeric'});
      },

      _computeLink: function(resource) {
        return resource.link || '/community/' + resource.relativePath;
      },

      _stripHTML: function(html) {
        var template = document.createElement('template');
        template.innerHTML = html;
        return html ? template.content.firstChild.textContent : '';
      },

      _toSVG: function(category) {
        return this._categorySVGMap[category];
      },

      _filterChanged: function(event) {
        var type = event.target.textContent.toLowerCase();
        var links = this.querySelectorAll('.sidebar-nav a');
        for (var i = 0; i < links.length; i++)
          links[i].removeAttribute('active');
        event.target.setAttribute('active', '');

        if (this.$.ajax.loading)
          this.$.ajax.lastRequest.abort();

        this._filterPath = type == 'all' ? '' : '/' + type;
        this._resources = null;
        this.$.ajax.params = {};
      },

    });
  </script>
</dom-module>
