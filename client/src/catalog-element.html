<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/app-route/app-location.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/iron-doc-viewer/iron-doc-viewer.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">

<link rel="import" href="catalog-element-readme.html">
<link rel="import" href="lazy-block.html">

<dom-module id="catalog-element">
  <template>
    <style>
      a {
        text-decoration: none;
      }

      #content {
        padding: 16px 32px;
        box-sizing: border-box;
        min-width: 200px;
        max-width: 980px;
        margin: 0 auto;
        animation: fade 167ms cubic-bezier(0, 0, 0.2, 1);
      }

      @keyframes fade {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      #content.hidden {
        animation: none;
      }

      #demo-frame {
        border: none;
        width: 100%;
        height: 100vh;
        position: absolute;
      }

      [hidden] {
        display: none;
      }
    </style>

    <app-location route="{{routeLocation}}"></app-location>
    <app-route
      route="{{route}}"
      pattern="/:owner"
      data="{{routeMatch}}"
      tail="{{routeTail}}"></app-route>

    <iron-ajax
      id="metaAjax"
      loading="{{loading}}"
      url="[[baseUrls.api]]/api/meta/[[routeMatch.owner]]/[[repo]][[versionRoute]]"
      handle-as="json"
      last-response="{{data}}"
      on-response="_handleResponse"></iron-ajax>

    <iron-ajax
      id="docsAjax"
      url="[[baseUrls.api]]/api/docs/[[routeMatch.owner]]/[[repo]][[versionRoute]]"
      handle-as="json"
      last-response="{{docs}}"
      on-response="_handleResponse"></iron-ajax>

    <lazy-block condition="[[!loading]]"></lazy-block>
    <lazy-block condition="[[docs]]"></lazy-block>


    <iron-icon icon="search"></iron-icon>
    <input type="search" placeholder="Search" on-tap="_navigateToSearch">

    <h2 title class="repo-title">[[repo]]</h2>
    [[data.version]]
    [[data.bower.description]]

    <img class="avatar" src="[[data.avatar_url]]&s=64">by [[routeMatch.owner]]

    <a href="https://github.com/[[routeMatch.owner]]/[[repo]]" target="_blank">View source on Github</a>

    <!-- Repository contents sidebar -->
    <template is="dom-repeat" items=[[bundledDemos]] as="demo">
      <a href="/element/[[routeMatch.owner]]/[[repo]]/[[data.version]]/demo/[[demo.path]]">
        <div>[[demo.desc]]</div>
      </a>
    </template>

    <template is="dom-repeat" items="[[bundledElements]]" as="element">
      <a href="/element/[[routeMatch.owner]]/[[repo]]/[[data.version]]/[[element.is]]">
        <div>[[element.is]]</div>
      </a>
    </template>
    <template is="dom-repeat" items="[[bundledBehaviors]]" as="behavior">
      <a href="/element/[[routeMatch.owner]]/[[repo]]/[[data.version]]/[[behavior.is]]">
        <div>[[behavior.is]]</div>
      </a>
    </template>

    <template is="dom-if" if="[[!demo]]">
      <div id="content" hidden="[[loading]]">
        <template is="dom-if" if="[[_showMainView(subElement, demo)]]">
          <catalog-element-readme data="[[data]]" base-urls="[[baseUrls]]"></catalog-element-readme>
        </template>

        <template is="dom-if" if="[[subElement]]">
          <h2 title>[[subElement]]</h2>
          <iron-doc-viewer descriptor="[[descriptor]]"></iron-doc-viewer>
        </template>
      </div>
    </template>

    <!-- TODO(samli): Lacking drawer button -->
    <template is="dom-if" if="[[demo]]">
      <iframe id="demo-frame"
              src="[[baseUrls.userContent]]/[[routeMatch.owner]]/[[repo]]/[[data.version]]/[[repo]]/[[demo]]">
      </iframe>
    </template>

    </app-drawer-layout>
  </template>

  <script>
    Polymer({

      is: 'catalog-element',

      properties: {
        visible: Boolean,

        route: String,

        baseUrls: Object
      },

      observers: [
        '_routeChanged(route, visible)',
        'onload(loading)'
      ],

      ready: function() {
        this._loaded = true;
        this._routeChanged(this.route, this.visible);
      },

      _showMainView: function(subElement, demo) {
        return !(subElement || demo);
      },

      _elements: function() {
        if (!this.docs)
          return [];
        return Object.keys(this.docs.elementsByTagName).map(function(elem) {
          return this.docs.elementsByTagName[elem];
        }.bind(this));
      },

      _behaviors: function() {
        if (!this.docs)
          return [];
        return Object.keys(this.docs.behaviorsByName).map(function(elem) {
          return this.docs.behaviorsByName[elem];
        }.bind(this));
      },

      _demos: function() {
        if (!this.docs || !this.bundledElements)
          return [];

        // Dedupe demos since elements can point to the same demo.
        var demosByPath = {};
        this.bundledElements.forEach(function(elem) {
          elem.demos.forEach(function(demo) {
            demosByPath[demo.path] = demo;
          });
        });

        return Object.keys(demosByPath).map(function(demoPath) {
          return demosByPath[demoPath];
        });
      },

      onload: function(loading) {
        if (!this.visible || !loading)
          return;

        this.data = {};
        this.descriptor = {};
        this.bundledElements = [];
        this.bundledBehaviors = [];
      },

      _splitRoute: function() {
        this.versionRoute = '';
        this.subElement = null;
        this.demo = null;

        var split = this.routeTail.path.split('/');
        split.shift(); // Skip first /
        this.repo = split.shift();

        if (split.length && split[0].indexOf('.') != -1)
          this.versionRoute = '/' + split.shift();
        else if (split.length && split[0].match(/[0-9a-f]{20,}/))
          this.versionRoute = '/' + split.shift();

        if (split.length && split[0].indexOf('demo') != -1) {
          split.shift();
          this.demo = split.join('/');
          split = [];
        }

        if (split.length)
          this.subElement = split.shift();
      },

      _routeChanged: function(route, visible) {
        if (!visible || !this._loaded || route.prefix !== '/element')
          return;

        this._splitRoute();
        document.title = this.routeMatch.owner + '/' + this.repo;

        // Generate requests
        if (!this._cachedData || this._cachedData !== this.repo) {
          this.$.metaAjax.generateRequest();
          this.$.docsAjax.generateRequest();
          this._cachedData = this.repo;
        } else {
          this._updateDescriptor();
        }
      },

      _handleResponse: function() {
        if (this.data)
          document.title = this.data.owner + '/' + this.data.repo;
        this._updateDescriptor();
      },

      _updateDescriptor: function() {
        if (!this.docs)
          return;
        this.bundledElements = this._elements();
        this.bundledBehaviors = this._behaviors();
        this.bundledDemos = this._demos();
        this.descriptor = this.docs.elementsByTagName[this.subElement] || this.docs.behaviorsByName[this.subElement];
      },

      _navigateToSearch: function() {
        this.set('routeLocation.path', '/search');
      },

    });
  </script>
</dom-module>
