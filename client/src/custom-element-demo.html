<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/prism-element/prism-highlighter.html">

<dom-module id="custom-element-demo">
  <!-- TODO: Support for external stylesheets is deprecated in favor of style modules. -->
  <link rel="import" type="css" href="../bower_components/github-markdown-css/github-markdown.css">
  <link rel="import" type="css" href="../bower_components/prism/themes/prism.css">
  <style>
    #expandSourceButton {
      display: block;
      width: 30px;
      height: 14px;
      line-height: 8px;
      margin-bottom: 8px;
      text-align: center;
      vertical-align: middle;
      border: 1px solid #bbb;
      border-radius: 4px;
      background: white;
      font-size: 8px;
      cursor: pointer;
    }

    #demoContainer {
      width: 100%;
      height: 0px;
      overflow: hidden;
      border: 1px solid #f7f7f7;
      opacity: 0;
    }

    #demoContainer.reveal {
      animation: reveal 300ms cubic-bezier(0, 0, 0.2, 1);
      opacity: 1;
      transition: opacity 300ms 100ms cubic-bezier(0, 0, 0.2, 1);
    }

    @keyframes reveal {
      from {
        height: 0px;
      }
    }

    #frame {
      border: none;
      width: 100%;
      height: 0px;
    }
  </style>
  <template>
    <prism-highlighter></prism-highlighter>
    <div id="demoContainer">
      <iframe id="frame"></iframe>
    </div>
    <div class="markdown-body">
      <pre id="source"></pre>
    </div>
  </template>

  <script>
    Polymer({

      is: 'custom-element-demo',

      properties: {
        data: Object,

        width: Number,

        height: Number,

        code: String,

        snippet: String,

        baseUrl: String,
      },

      observers: [
        '_setDemo(data, code)',
        '_setFrame(baseUrl, data)',
        '_updateSource(snippet)',
        '_updateSource(code)',
      ],

      _expandSource: function() {
        this.$.source.innerHTML = this.highlight(this.code);
      },

      highlight: function(code) {
        return this.fire('syntax-highlight', {code: code}).detail.code;
      },

      _updateSource: function() {
        this.$.source.innerHTML = this.highlight(this.snippet || this.code);

        if (this.snippet) {
          // TODO: Make this button accessible.
          var expandButton = document.createElement('span');
          expandButton.id = 'expandSourceButton';
          expandButton.textContent = '...';
          expandButton.addEventListener('click', this._expandSource.bind(this));
          Polymer.dom(this.$.source).insertBefore(expandButton, this.$.source.firstChild);
        }
      },

      _setFrame: function() {
        this.$.frame.src = this.baseUrl + '/' + this.data.owner + '/' + this.data.repo + '/' + this.data.version + '/' + this.data.repo + '/';
        this.$.frame.style.minWidth = this.width || 0;
        this.$.frame.style.minHeight = this.height || 0;

        window.addEventListener('message', this._onDemoLoad.bind(this), false);
      },

      _setDemo: function() {
        if (this._frameReady)
          this._setDemoInFrame();
        else
          this.$.frame.onload = this._setDemoInFrame.bind(this);
      },

      _setDemoInFrame: function() {
        this._frameReady = true;
        this.$.frame.contentWindow.postMessage(this.code, '*');
      },

      _onDemoLoad: function(event) {
        this.$.demoContainer.classList.add('reveal');
        this.$.frame.style.height = event.data.height + 'px';
        this.$.demoContainer.style.height = event.data.height + 'px';
      }

    });
  </script>
</dom-module>
