<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/iron-list/iron-list.html">
<link rel="import" href="../bower_components/iron-scroll-threshold/iron-scroll-threshold.html">
<link rel="import" href="catalog-dialog.html">

<dom-module id="search-focus">
  <template>
    <style>
      catalog-dialog {
        border-radius: 4px;
        position: fixed;
        margin: 0;
        top: 0;
        left: 0;
        overflow: hidden;
        font-family: var(--theme-font);
        font-size: 16px;
        line-height: 24px;
        overflow: overlay;
      }

      a {
        color: inherit;
        text-decoration: none;
      }

      #search-box {
        box-sizing: border-box;
        width: 500px;
        height: 40px;
        font-family: var(--theme-font);
        font-size: 16px;
        padding: 12px;
        border: 1px solid #ededed;
        border-radius: 4px;
        margin: 0;
      }

      iron-scroll-threshold {
        margin: 0;
        max-height: 600px;
        padding: 0;
      }

      #collections {
        box-sizing: border-box;
        width: 500px;
        display: flex;
        flex-wrap: nowrap;
        overflow: auto;
      }

      .title {
        font-weight: bold;
        font-size: 20px;
      }

      .owner {
        color: hsl(0, 0%, 50%);
      }

      #collections > a {
        flex: 0 0 250px;
        height: 150px;
        padding: 16px;
        border-right: 1px solid #ededed;
      }

      .element {
        padding: 16px;
        border-top: 1px solid #ededed;
      }

      @media (max-width: 500px), (max-height: 500px) {
        catalog-dialog {
          width: 100%;
          border-radius: 0;
          height: 100%;
        }

        #search-box, #collections {
          width: 100%;
        }

        iron-scroll-threshold {
          max-height: calc(100% - 40px);
        }
      }
    </style>

    <iron-ajax
      id="elementAjax"
      url="[[baseUrls.api]]/api/search/[[_query]] kind:element"
      handle-as="json"
      on-request="_handleRequest"
      on-response="_elementResponse"
      params="[[_requestParams]]"></iron-ajax>

    <iron-ajax
      id="collectionAjax"
      url="[[baseUrls.api]]/api/search/[[_query]] kind:collection"
      handle-as="json"
      last-response="{{_collections}}"
      on-request="_handleRequest"
      debounce-duration="300"></iron-ajax>

    <catalog-dialog id="dialog" with-backdrop on-iron-overlay-opened="_dialogOpened">
      <input type="search" id="search-box" on-keyup="_onSearchKeyUp" placeholder="Search webcomponents.org"></input>

      <iron-scroll-threshold on-lower-threshold="_loadMoreResults" id="threshold" lower-threshold="200">
        <div id="collections">
          <template is="dom-repeat" items="[[_collections.results]]">
            <a href="/collection/[[item.owner]]/[[item.repo]]" on-click="close">
              <div class="collection">
                <div class="title"><span class="owner">[[item.owner]]</span>/[[item.repo]]</div>
                <div class="description">[[item.description]]</div>
              </div>
            </a>
          </template>
        </div>
        <iron-list id="resultsList" items="[[_results]]" as="item" scroll-target="threshold">
          <template>
            <a href="/element/[[item.owner]]/[[item.repo]]" tabindex$="[[tabIndex]]" on-click="close">
              <div class="element">
                <div class="title"><span class="owner">[[item.owner]]</span>/[[item.repo]]</div>
                <div class="description">[[item.description]]</div>
              </div>
            </a>
          </template>
        </iron-list>
      </iron-scroll-threshold>
    </catalog-dialog>

  </template>

  <script>
    Polymer({

      is: 'search-focus',

      properties: {
        baseUrls: Object,

        query: String,

        _requestParams: Object
      },

      observers: [
        '_queryChanged(query)'
      ],

      open: function(left, top) {
        var dialog = this.$.dialog;
        dialog.open();

        this.$['search-box'].select();

        if (window.matchMedia("(max-width: 500px), (max-height: 500px)").matches)
          return;
        dialog.style.top = top + 'px';
        dialog.style.left = left + 'px';
      },

      close: function() {
        this.$.dialog.close();
      },

      _dialogOpened: function() {
        this.$['search-box'].focus();
      },

      _queryChanged: function(query) {
        this.$['search-box'].value = query;
        this._onSearchKeyUp();
      },

      _onSearchKeyUp: function() {
        var query = this.$['search-box'].value;
        if (query == this._query)
          return;

        if (!this._query || this._query != query) {
          this._requestParams = {offset: 0};
          this._endOfResults = false;
        }
        this._query = query;
        this._results = [];
        this._generateSearch();
      },

      _generateSearch: function() {
        this.debounce('searchAPI', function() {
          this.$.elementAjax.generateRequest();
          this.$.collectionAjax.generateRequest();
          if (window.ga)
            window.ga('send', 'pageview', '/_internal/search?q=' + this._query);
        }.bind(this), 300);
      },

      _handleRequest: function(event) {
        var query = this.$['search-box'].value;
        if (!query)
          event.detail.request.abort();
      },

      _elementResponse: function(event) {
        var response = event.detail.response;
        if (!response || !response.results)
          return;

        if (!response.results.length) {
          this._endOfResults = true;
          return;
        }

        var scrollTop = this.$.threshold.scrollTop;
        this._results = this._results.concat(response.results);
        Polymer.dom.flush();
        this.$.threshold.scroll(0, scrollTop);
        this.$.threshold.clearTriggers();
      },

      _loadMoreResults: function() {
        if (!this._results || this._endOfResults)
          return;
        this.set('_requestParams.offset', this._results.length);
        this.$.elementAjax.generateRequest();
      },

    });
  </script>
</dom-module>
